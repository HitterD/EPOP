# Backend API Overview

- **Base URL**
  - REST base: `/api/v1`
  - Swagger UI: `/docs`
  - OpenAPI JSON: `/docs-json`
  - Prefix/version: set in `backend/src/main.ts` via `app.setGlobalPrefix('api')` and URI versioning `v1`.

- **Auth model**
  - HTTP-only cookies: `accessToken` (JWT), `refreshToken`.
  - Endpoints (`backend/src/auth/auth.controller.ts`):
    - `POST /auth/login`
    - `POST /auth/refresh`
    - `POST /auth/logout`
    - `GET /auth/sessions` list
    - `DELETE /auth/sessions/:id` revoke
    - `POST /auth/sessions/revoke-all`
    - `POST /auth/password/forgot`
    - `POST /auth/password/reset`
    - `POST /auth/push/subscribe`

- **Authorization (RBAC)**
  - Decorator `@Roles('admin')` and global `RolesGuard` check `req.user.adm`.
  - See `backend/src/common/decorators/roles.decorator.ts` and `backend/src/common/guards/roles.guard.ts`.

- **Error envelope**
  - Global filter `AllExceptionsFilter` formats errors as:
```json
{
  "code": "HttpException|InternalServerError|...",
  "message": "...",
  "details": {"...": "..."},
  "requestId": "uuid",
  "traceId": "uuid",
  "ts": "2025-01-01T00:00:00.000Z",
  "path": "/api/..."
}
```
  - Source: `backend/src/common/filters/all-exceptions.filter.ts`.

- **Idempotency-Key**
  - Header: `Idempotency-Key` for POST/PUT/PATCH/DELETE.
  - Cached 24h in Redis by `IdempotencyInterceptor`.
  - Source: `backend/src/common/interceptors/idempotency.interceptor.ts`.

- **Cursor pagination**
  - Request: `?limit=20&cursor=base64url({ id | off })` (`CursorParamsDto`).
  - Response: `{ items, nextCursor?, hasMore }`.
  - Helpers: `backend/src/common/pagination/cursor.ts`, DTOs in `backend/src/common/dto/*`.

- **Caching headers**
  - Strong `ETag` globally (Express setting).
  - `Last-Modified` set opportunistically by `LastModifiedInterceptor`.

- **Security & rate limiting**
  - Helmet CSP, nosniff, CORP; 10MB JSON/urlencoded limits.
  - Global throttling via `@nestjs/throttler` (env: `RATE_LIMIT_WINDOW_MS`, `RATE_LIMIT_MAX`).
  - Source: `backend/src/main.ts`, `backend/src/app.module.ts`.

- **Key resource endpoints**
  - Chats: `backend/src/chat/chat.controller.ts` (`/chats/...`)
  - Projects: `backend/src/projects/projects.controller.ts` (`/projects/...`)
  - Files: `backend/src/files/files.controller.ts` (`/files/presign`, `/files/attach`, `/files/:id/download`, `/files/purge-temp` [admin])
  - Directory: `backend/src/directory/directory.controller.ts` (move/import)
  - Search: `backend/src/search/search.controller.ts` (admin reindex)
  - Notifications: `backend/src/notifications/notifications.controller.ts`
  - Admin: `backend/src/admin/admin.controller.ts`

- **Files lifecycle**
  - Presign uploads go to `uploads-temp/` with 5 min expiry; after `POST /files/attach`, server finalizes by copying to `uploads/` and deletes the temp object.
  - `GET /files/:id/download` streams directly from MinIO with appropriate headers.
  - Admin can purge orphan temp files older than 24h: `POST /files/purge-temp { olderThanHours? }`.

- **OpenAPI**
  - Generated by `@nestjs/swagger` in `backend/src/main.ts`.
  - FE may typegen against `/docs-json`.
